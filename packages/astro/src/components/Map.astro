---
/**
 * @file Basic Map component for inline maps
 * @module @maplibre-yaml/astro/components/Map
 *
 * @description
 * A basic map component that renders an interactive MapLibre map using
 * YAML configuration. Supports both build-time loaded configs and runtime
 * loading from public directory.
 *
 * ## Features
 *
 * - **Dual Loading**: Use `config` for build-time or `src` for runtime
 * - **Web Component**: Wraps the `<ml-map>` web component from @maplibre-yaml/core
 * - **Customizable**: Height, class, and style props for layout control
 * - **Type Safe**: Full TypeScript support with MapBlock validation
 *
 * @example Build-time loading
 * ```astro
 * ---
 * import { Map, loadMapConfig } from '@maplibre-yaml/astro';
 * const config = await loadMapConfig('./src/configs/earthquake-map.yaml');
 * ---
 * <Map config={config} height="500px" />
 * ```
 *
 * @example Runtime loading
 * ```astro
 * ---
 * import { Map } from '@maplibre-yaml/astro';
 * ---
 * <Map src="/configs/map.yaml" height="400px" />
 * ```
 *
 * @example With custom styling
 * ```astro
 * <Map
 *   src="/configs/dashboard.yaml"
 *   height="600px"
 *   class="map-container"
 *   style="border: 2px solid #ccc; border-radius: 8px;"
 * />
 * ```
 */

import type { MapProps } from "../types";
import "@maplibre-yaml/core/register";

interface Props extends MapProps {}

const { src, config, height = "400px", class: className, style } = Astro.props;

// Validate that either src or config is provided
if (!src && !config) {
  throw new Error("Map component requires either 'src' or 'config' prop");
}

// If both are provided, prefer config
if (src && config) {
  console.warn(
    "Map component received both 'src' and 'config' props. Using 'config' and ignoring 'src'."
  );
}

// Generate unique ID for this map instance
const mapId = `map-${Math.random().toString(36).substring(2, 11)}`;

// Serialize config for client-side if provided
const serializedConfig = config ? JSON.stringify(config) : null;
---

<div
  class:list={["ml-map-container", className]}
  style={`height: ${height}; width: 100%; position: relative; ${style || ""}`}
  data-map-id={mapId}
>
  {
    config ? (
      // Build-time loaded config: render directly with web component
      <ml-map id={mapId} config={serializedConfig!} />
    ) : (
      // Runtime loaded config: placeholder that will be populated by client script
      <ml-map id={mapId} data-src={src} />
    )
  }
</div>

{
  src && !config && (
    <script is:inline define:vars={{ mapId, src }}>
      // Runtime YAML loading for src prop
      (async () => {
        try {
          const mapElement = document.getElementById(mapId);
          if (!mapElement) {
            console.error(`Map element with id ${mapId} not found`);
            return;
          }

          // Fetch YAML file from public directory
          const response = await fetch(src);
          if (!response.ok) {
            throw new Error(
              `Failed to fetch ${src}: ${response.status} ${response.statusText}`
            );
          }

          const yamlText = await response.text();

          // Parse YAML using the core library
          const { YAMLParser } = await import("@maplibre-yaml/core");
          const result = YAMLParser.safeParseMapBlock(yamlText);

          if (!result.success) {
            console.error("Map configuration validation failed:", result.errors);
            mapElement.innerHTML = `
              <div style="
                padding: 20px;
                background: #fee;
                border: 1px solid #fcc;
                border-radius: 4px;
                color: #c33;
              ">
                <strong>Map Configuration Error</strong>
                <ul style="margin: 10px 0; padding-left: 20px;">
                  ${result.errors
                    .map(
                      (err) =>
                        `<li>${err.path ? err.path + ": " : ""}${err.message}</li>`
                    )
                    .join("")}
                </ul>
              </div>
            `;
            return;
          }

          // Set config on the web component
          mapElement.setAttribute("config", JSON.stringify(result.data));
        } catch (error) {
          console.error("Failed to load map configuration:", error);
          const mapElement = document.getElementById(mapId);
          if (mapElement) {
            mapElement.innerHTML = `
              <div style="
                padding: 20px;
                background: #fee;
                border: 1px solid #fcc;
                border-radius: 4px;
                color: #c33;
              ">
                <strong>Map Loading Error</strong>
                <p style="margin: 10px 0;">${
                  error instanceof Error ? error.message : String(error)
                }</p>
              </div>
            `;
          }
        }
      })();
    </script>
  )
}

<style>
  .ml-map-container {
    display: block;
    overflow: hidden;
  }

  ml-map {
    display: block;
    width: 100%;
    height: 100%;
  }

  /* Loading state */
  ml-map:not([config]) {
    background: linear-gradient(
      135deg,
      #f5f5f5 25%,
      transparent 25%,
      transparent 50%,
      #f5f5f5 50%,
      #f5f5f5 75%,
      transparent 75%,
      transparent
    );
    background-size: 40px 40px;
    animation: loading-pattern 1s linear infinite;
  }

  @keyframes loading-pattern {
    0% {
      background-position: 0 0;
    }
    100% {
      background-position: 40px 40px;
    }
  }

  /* Error state styles are inline in the script for better visibility */
</style>
