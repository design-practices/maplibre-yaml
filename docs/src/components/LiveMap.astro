---
interface Props {
  yaml?: string;
  src?: string;
  height?: string;
  caption?: string;
}

const { yaml, src, height = '400px', caption } = Astro.props;

import { YAMLParser } from '@maplibre-yaml/core';

let configJson = null;
let error = null;

// If yaml prop is provided, parse it (legacy pattern)
if (yaml) {
  const cleanedYaml = yaml.trim();
  const result = YAMLParser.safeParseMapBlock(cleanedYaml);
  configJson = result.success ? JSON.stringify(result.data) : null;
  error = result.success ? null : result.errors;
}
---

<figure class="livemap-container">
  {error ? (
    <div class="livemap-error">
      <h4>YAML Parsing Error</h4>
      <pre>{JSON.stringify(error, null, 2)}</pre>
    </div>
  ) : (
    <div class="livemap-wrapper">
      {src ? (
        <ml-map src={src} style={`height: ${height}; display: block;`}></ml-map>
      ) : (
        <ml-map style={`height: ${height}; display: block;`} config={configJson}></ml-map>
      )}
    </div>
  )}
  {caption && <figcaption>{caption}</figcaption>}
</figure>

<script>
  import '@maplibre-yaml/core/register';
  import 'maplibre-gl/dist/maplibre-gl.css';
</script>

<style>
  .livemap-container {
    margin: 1.5rem 0;
  }
  .livemap-wrapper {
    border-radius: 8px;
    border: 1px solid var(--sl-color-gray-5);
    overflow: hidden;
  }
  figcaption {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: var(--sl-color-gray-3);
    text-align: center;
    font-style: italic;
  }
</style>
